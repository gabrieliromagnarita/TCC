<HTML lang="pt-br">
    <HEAD>
        <title>{% block title %}Título{% endblock %}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='estilo.css') }}">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=1240,shrink-to-fit=no">
    </HEAD>
    <BODY>
        <div id="header">
            <img src="{{ url_for('static',  filename='imagens/logo-face-a-face.png')}}" id="logo-face-a-face">
            <div id="icons">
                <img src="{{ url_for('static',  filename='imagens/search-bar-icon.png')}}" id="search-bar-icon">
                <img src="{{ url_for('static',  filename='imagens/user-icon.png')}}" id="user-icon">
                <a href="/carrinho-render"><img src="{{ url_for('static',  filename='imagens/shopping-cart-icon.png')}}" id="shopping-cart-icon"></a>
            </div>
        </div>
        <div id="sub-header">
            <a href="/historia-render" class="header-text historia">HISTÓRIA</a> 
            <a href="/home-render" class="header-text home">HOME</a> 
            <a href="/faq-render" class="header-text faq">FAQ</a>
            {% set u = session.get('user') %}
            {% if u and u.get('email') == 'gabihromagna@gmail.com' %}
                <a href="{{ url_for('admin.admin') }}" class="header-text-adm admin">ADM</a>
            {% endif %}
        </div>
        {% block content %}{% endblock %}

        <!-- modal user -->
        <div id="account-modal" class="modal-user">
            <div class="content-modal-user">
                <span class="fechar-user">&times;</span>
                {% set u = session.get('user') %}
                {% if u and u is mapping %}
                    <img src="{{ url_for('static',  filename='imagens/alterar-info-icon.png')}}" id="alterar-info-icon">
                    <p class="nome-modal-user">{{ u.get('nome', '') }}</p>
                    {% if u.get('email') == 'gabihromagna@gmail.com' %}
                        <p class="admin-tag-modal-user">ADMINISTRADOR</p>
                    {% endif %}
                    <p class="email-modal-user"><strong>Email:</strong> {{ u.get('email', '') }}</p>
                    <p class="fone-modal-user"><strong>Telefone:</strong> {{ u.get('telefone', '') }}</p>
                    <p class="nasc-modal-user"><strong>Nascimento:</strong> {{ u.get('nascimento', '') }}</p>
                    <a href="{{ url_for('login.logout') }}" class="botao-logout">SAIR DA CONTA</a>
                    <a href="" class="botao-delete">excluir conta</a>
                {% else %}
                    <p>Você não está logado.</p>
                    <a href="{{ url_for('login.login') }}">Entrar</a>
                {% endif %}
            </div>
        </div>

        <!-- modal alterar -->
        <div id="update-account-modal" class="update-modal-user">
            <div class="content-modal-update">
                <span class="fechar-update">&times;</span>
                
                <label>E-mail:</label>
                <input type="email" name="email-modal-update" class="modal-update-input email" value="{{ u.get('email','') }}" readonly>
                <a href="#" class="btn-mudar-senha">ALTERAR SENHA</a>

                <label>Nome:</label>
                <input type="text" name="nome-modal-update" class="modal-update-input nome" value="{{ u.get('nome','') }}" readonly>
                
                <label>Telefone:</label>
                <input type="tel" name="fone-modal-update" class="modal-update-input fone" value="{{ u.get('tel','') }}" readonly>
                <label>Data de nascimento:</label>
                <input type="text" name="dataNasc-modal-update" class="modal-update-input dataNasc" placeholder="DD/MM/AAAA" maxlength="10" value="{{ u.get('dataNasc','') }}" readonly>
            </div>
        </div>
        {% block scripts %}
        <script>
            document.addEventListener('DOMContentLoaded', function(){
                const inputFone = document.querySelector('.fone');
                const inputData = document.querySelector('.dataNasc');

                const modal = document.getElementById('account-modal');
                const btn = document.getElementById('user-icon');
                const span = document.getElementsByClassName('fechar-user')[0];

                const modal_update = document.getElementById('update-account-modal');
                const btn_update = document.getElementById('alterar-info-icon');
                const span_update = document.getElementsByClassName('fechar-update')[0];
                
                if (btn) {
                    btn.onclick = () => modal.style.display = 'block';
                }

                if (span) {
                    span.onclick = () => modal.style.display = 'none';
                }

                if (btn_update) {
                    btn_update.onclick = () => modal_update.style.display = 'block';
                }

                if (span_update) {
                    span_update.onclick = () => modal_update.style.display = 'none';
                }
                
                window.onclick = function(event) {
                    if (event.target == modal) modal.style.display = 'none';
                    if (event.target == modal_update) modal_update.style.display = 'none';
                }

                // mask do telefone
                if(inputFone){
                    inputFone.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 11) value = value.slice(0, 11);
                        if (value.length > 6) {
                            e.target.value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
                        } else if (value.length > 2) {
                            e.target.value = value.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
                        } else {
                            e.target.value = value.replace(/^(\d*)/, '($1');
                        }
                    });
                }
                
                // mask da data
                if(inputData){
                    inputData.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 8) value = value.slice(0, 8);
                        if (value.length > 4) {
                            e.target.value = value.replace(/^(\d{2})(\d{2})(\d{0,4}).*/, '$1/$2/$3');
                        } else if (value.length > 2) {
                            e.target.value = value.replace(/^(\d{2})(\d{0,2})/, '$1/$2');
                        } else {
                            e.target.value = value;
                        }
                    });
                }  
            })

            document.querySelectorAll('.modal-update-input').forEach(input => {
                input.addEventListener('click', () => {
                    input.removeAttribute('readonly');
                    input.focus();

                    if(!input.nextElementSibling || !input.nextElementSibling.classList.contains('btn-salvar')){
                        const salvarBtn = document.createElement('button');
                        salvarBtn.textContent = 'SALVAR MUDANÇAS';
                        salvarBtn.className = 'btn-salvar';
                        input.after(salvarBtn);

                        salvarBtn.addEventListener('click', async () => {
                            const campo = input.classList[1];
                            const valor = input.value.trim();

                            const res = await fetch(`/update-user/${campo}`, {method: 'post', headers: {'Content-Type':'application/json'}, body: JSON.stringify({valor})});

                            const data = await res.json();
                            if(data.success){alert(`${field} atualizado com sucesso`);
                                input.setAttribute('readonly', true);
                                salvarBtn.remove();
                            }else alert('Erro' + data.error);
                        });
                    }
                });
            });

            //terminar de assistir o vídeo
            document.querySelectorAll('.btn-update-senha').addEventListener('click', () => {
                const senhaInput = document.createElement('input');
                senhaInput.type = 'password';
                senhaInput.className = 'modal-update-input senha';
                senhaInput.placeholder = 'Nova senha';

                const confirmaBtn = document.createElement('button');
                confirmaBtn.textContent = 'Salvar senha';

                confirmaBtn.addEventListener('click', async () => {
                    const valor = senhaInput.value.trim();
                    if(!valor) return alert('Informe a senha')
                })

            
            });
        </script>
        {% endblock %}
    </body>
</html>