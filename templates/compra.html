{% extends 'base.html' %}

{% block title %}Página Inicial{% endblock %}

{% block content %}
<div id="content-compra">
        {% if produtos %}
            <ul>
                {% for p in produtos %}
                <li style="margin-bottom: 20px;">
                    <strong>{{ p.nome }}</strong> - R$ {{ "%.2f"|format(p.preco) }} {{ p.quantidade }}
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>erro: carrinho vazio</p>
        {% endif %}
        <form method="post" class="div-radio-compra" action="{{ url_for('compra.comprar')}}">
            <label>Método de pagamento:</label>
            <input type="radio" id="pix" name="tipo-pag" value="pix">
            <label for="pix">Pix</label>

            <input type="text" name="cep-compra" class="compra-input-cep" placeholder="CEP:" required>
            <input type="text" name="desconto-compra" class="compra-input-desconto" placeholder="Cupom de desconto:">
            <p id="frete-info"></p>
            <p id="total-compra"><strong>Total:</strong> R$ <span id="valor-total">{{ "%.2f"|format(total) }}</span></p>
            
            <input type="hidden" name="total-final" id="total-final" value="{{ '%.2f'|format(total) }}">
            
            <button type="submit" class="btn-comprar-compra">COMPRAR</button>
        </form>
        {% if pag_info %}
            {% if pag_info.tipo == "pix" %}
                <div class="pix-pagamento">
                    <h3>Escaneie o QR Code para pagar:</h3>
                    <img src="data:image/png;base64,{{ pag_info.qr_code_img }}" alt="QR Code PIX" class="qr-pix-compra">
                    <p><strong>Ou copie a chave PIX:</strong></p>
                    <textarea readonly style="width:100%;height:100px;">{{ pag_info.chave }}</textarea>
                </div>
            {% endif %}
        {% endif %}
        
    </div>

    <div class="divisoria-vertical-compra"></div>

    <div class="div-right-compra">
        <p>QR Code</p>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function(){
        const cep = document.querySelector('input[name="cep-compra"]');
        const totalFrete = document.querySelector('#total-compra');
        const totalHidden = document.querySelector('#total-final');
        const form = document.querySelector('form.div-radio-compra');

        let totalBase = parseFloat("{{ total }}");
        let valorFrete = 0;

        cep.addEventListener('blur', function(){
            if (cep.value.length === 8) {
                fetch("{{ url_for('compra.calculo_frete')}}", {
                    method: 'post',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({ 'cep-compra': cep.value })
                }).then(res => res.json()).then(data => {
                    const frete = data[0];
                    const totalComFrete = totalBase + frete.valor;

                    totalSpan.innerText = totalComFrete.toFixed(2);
                    freteInfo.innerText = `Frete (${frete.servico}): R$ ${frete.valor.toFixed(2)} - ${frete.prazo} dias úteis`;

                    totalHidden.value = totalComFrete.toFixed(2);

                    document.querySelector('#frete-info').innerText = `Frete (${frete.servico}): R$ ${frete.valor.toFixed(2)} - ${frete.prazo} dias úteis`;
                }).catch(() => alert("ERRO DE CONEXÃO CORREIOS"));
            }
        });
    });
</script>
{% endblock %}